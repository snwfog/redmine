// Generated by CoffeeScript 1.6.2
(function() {
  $(function() {
    var expandFavorite, expandRegular;

    $('span.expander').on('click', function(event) {
      if ($('#only-favorite-projects').hasClass('all')) {
        return $(this).trigger('click.regular');
      } else {
        return $(this).trigger('click.favorite');
      }
    });
    expandRegular = function(event) {
      if ($(this).parents('tr').hasClass('open')) {
        $(this).collapseExpander();
      } else {
        $(this).expandExpander();
      }
      return $('table').redrawTableStrip();
    };
    expandFavorite = function(event) {
      return console.log("Expanding favorites only...");
    };
    $.fn.collapseExpander = function() {
      var $parentProjects, $tr, projectId;

      $tr = this.parents('tr');
      $tr.removeClass('open').addClass('closed');
      projectId = $tr.attr('id').match(/[\d]{4}/);
      $("tr.open.parent." + projectId + " span.expander").each(function() {
        return $(this).collapseExpander();
      });
      $("tr.child." + projectId).hide();
      $parentProjects = $("tr.parent.closed." + projectId);
      if ($parentProjects.exists()) {
        return $parentProjects.each(function() {
          return $(this).hide();
        });
      }
    };
    $.fn.expandExpander = function() {
      var $parentProjects, $tr, projectId;

      $tr = this.parents('tr');
      $tr.removeClass('closed').addClass('open');
      projectId = $tr.attr('id').match(/[\d]{4}/);
      $("tr.closed.parent." + projectId + " span.expander").each(function() {
        return $(this).expandExpander();
      });
      $("tr.child." + projectId).show();
      $parentProjects = $("tr.parent.open." + projectId);
      if ($parentProjects.exists()) {
        return $parentProjects.each(function() {
          return $(this).show();
        });
      }
    };
    $('tbody tr form').on('ajax:success', function(evt, data, status, xhr) {
      var $parentTr, $submitType;

      $parentTr = $(this).parents('tr');
      $submitType = $(this).find('input[name="_method"]');
      if ($parentTr.hasClass('fav')) {
        $parentTr.removeClass('fav').addClass('unfav');
        $(this).find('input[type="submit"]').removeClass('fav').addClass('unfav');
        if ($submitType != null) {
          return $submitType.attr('value', 'post');
        }
      } else if ($parentTr.hasClass('unfav')) {
        $parentTr.removeClass('unfav').addClass('fav');
        if (!$submitType.exists()) {
          $submitType = $('<input>').attr('name', '_method').attr('type', 'hidden');
          $(this).find('div').prepend($submitType);
        }
        $submitType.attr('value', 'delete');
        $(this).find('input[type="submit"]').removeClass('unfav').addClass('fav');
        return $(this).tagParent();
      }
    }).bind('ajax:failure', function(evt, data, status, xhr) {
      return console.log("Something went horribly wrong. And it's all Charles' faults");
    });
    $.fn.tagParent = function() {
      var $el, $tr, closestParent, klazz, parents;

      $el = this;
      klazz = $el.parents('tr').attr('class');
      parents = klazz.match(/[\d]{4}/g);
      if (parents) {
        closestParent = parents.reverse()[0];
        console.group("Flagging parent span " + closestParent);
        $tr = $("tr#" + closestParent + "span");
        console.log($tr.get(0));
        if (!$tr.hasClass('fav')) {
          $tr.find('form').submit();
        }
        return console.groupEnd();
      }
    };
    $.fn.exists = function() {
      return this.length !== 0;
    };
    $('.project-custom-label-filter').change(function(e) {
      $(this).find('input[type=checkbox]').each(function() {
        var $td, classId;

        classId = $(this).data('field');
        $td = $("#projects-list .custom-field-" + classId);
        if ($(this).is(':checked')) {
          return $td.css("display", "");
        } else {
          return $td.css("display", "none");
        }
      });
      return $(this).submit();
    });
    $('#collapse-expand-all-projects').on('click', function(e) {
      var $anchor;

      e.preventDefault();
      $anchor = $(this);
      if ($anchor.hasClass('expanded')) {
        $anchor.addClass('collapsed').removeClass('expanded');
        $('tr.open.parent span.expander').toggleExpander();
        $anchor.html("Expand All");
      } else if ($anchor.hasClass('collapsed')) {
        $anchor.addClass('expanded').removeClass('collapsed');
        $('tr.closed.parent span.expander').toggleExpander();
        $anchor.html("Collapse All");
      }
      return $('table').redrawTableStrip();
    });
    $('#only-favorite-projects').on('click', function(e) {
      var $anchor;

      e.preventDefault();
      $anchor = $(this);
      if ($anchor.hasClass('all')) {
        $anchor.removeClass('all').addClass('fav');
        $anchor.html("Show All Projects");
        $('#collapse-expand-all-projects').hide();
        $('#projects-list tbody tr').each(function() {
          if ($(this).hasClass('fav')) {
            $(this).removeClass('hide');
          }
          if (!$(this).hasClass('fav')) {
            return $(this).addClass('hide');
          }
        });
        $('span.expander').off('click.regular');
        $('span.expander').on('click.favorite', expandFavorite);
      } else if ($anchor.hasClass('fav')) {
        $anchor.removeClass('fav').addClass('all');
        $anchor.html("Only Favorites");
        $('#collapse-expand-all-projects').show();
        $('#projects-list tbody tr').each(function() {
          return $(this).removeClass('hide');
        });
        $('#collapse-expand-all-projects').html("Collapse All");
        $('#collapse-expand-all-projects').removeClass('collapsed').addClass('expanded');
        $('span.expander').off('click.favorite');
        $('span.expander').on('click.regular', expandRegular);
      }
      return $('table').redrawTableStrip();
    });
    $.fn.toggleExpander = function() {
      return this.each(function() {
        if (typeof this.onclick === 'function') {
          return this.onclick.call();
        }
      });
    };
    $.fn.redrawTableStrip = function() {
      var alt;

      alt = 1;
      return this.find('tbody tr:not(tr.hide)').each(function() {
        var klass;

        $(this).removeClass('even odd');
        klass = ((alt++) % 2) === 0 ? "even" : "odd";
        return $(this).addClass(klass);
      });
    };
    $('#only-favorite-projects').trigger('click');
    return $('.project-custom-label-filter').trigger('change');
  });

}).call(this);
